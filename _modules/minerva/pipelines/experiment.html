

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>minerva.pipelines.experiment &mdash; minerva  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            minerva
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../design.html">Minerva Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Examples and Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to Minerva</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">Programming Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">minerva</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">minerva.pipelines.experiment</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for minerva.pipelines.experiment</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lightning</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">L</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.loggers</span><span class="w"> </span><span class="kn">import</span> <span class="n">CSVLogger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightning.pytorch.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ModelCheckpoint</span><span class="p">,</span>
    <span class="n">TQDMProgressBar</span> <span class="k">as</span> <span class="n">ProgressBar</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torchmetrics</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">minerva.data.data_modules.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinervaDataModule</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">minerva.pipelines.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">minerva.utils.typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathLike</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">asdict</span><span class="p">,</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">minerva.utils.string_ops</span><span class="w"> </span><span class="kn">import</span> <span class="n">tree_like_formating</span><span class="p">,</span> <span class="n">indent_text</span>


<div class="viewcode-block" id="ModelInstantiator">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.ModelInstantiator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelInstantiator</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for lazy instantiation of PyTorch Lightning models.</span>

<span class="sd">    This interface defines a standardized way to construct models in three</span>
<span class="sd">    common training scenarios:</span>

<span class="sd">    1. Training from scratch: the entire model (backbone + head) is randomly</span>
<span class="sd">       initialized.</span>
<span class="sd">    2. Finetuning: a pretrained backbone is loaded from a checkpoint, while the</span>
<span class="sd">       head is randomly initialized.</span>
<span class="sd">    3. Inference/Evaluation: the full model is restored from a previously</span>
<span class="sd">       saved checkpoint. Usually, this checkpoint is generated using one of the</span>
<span class="sd">       two scenarios above.</span>

<span class="sd">    This abstraction allows for flexible and decoupled model construction across</span>
<span class="sd">    various stages of the machine learning lifecycle. Thus, is expected that</span>
<span class="sd">    model&#39;s architecture follows the same pattern as the one below:</span>

<span class="sd">        +-------------------------------+</span>
<span class="sd">        |   Model (LightningModule)     |</span>
<span class="sd">        |                               |</span>
<span class="sd">        |     +-----------------+       |</span>
<span class="sd">        |     |    Backbone     |       |   --&gt; Feature extractor</span>
<span class="sd">        |     +-----------------+       |</span>
<span class="sd">        |             |                 |</span>
<span class="sd">        |             v                 |</span>
<span class="sd">        |        +----------+           |</span>
<span class="sd">        |        |   Head   |           |   --&gt; Task-specific layers</span>
<span class="sd">        |        +----------+           |</span>
<span class="sd">        +-------------------------------+</span>

<span class="sd">    Definitions</span>
<span class="sd">    -----------</span>
<span class="sd">    - Backbone: Core feature extractor (e.g., ResNet, Transformer encoder).</span>
<span class="sd">    - Head: Task-specific layers (e.g., classification head, regression head).</span>

<span class="sd">    Implementations of this class should handle the appropriate model loading</span>
<span class="sd">    logic for each use case described above.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ModelInstantiator.create_model_randomly_initialized">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.ModelInstantiator.create_model_randomly_initialized">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_model_randomly_initialized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a model with both backbone and head randomly initialized.</span>
<span class="sd">        Typically used when training a model from scratch.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        L.LightningModule</span>
<span class="sd">            A Lightning model fully initialized with random weights, ready for</span>
<span class="sd">            training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;create_model_randomly_initialized must be implemented.&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ModelInstantiator.create_model_and_load_backbone">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.ModelInstantiator.create_model_and_load_backbone">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_model_and_load_backbone</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">backbone_checkpoint_path</span><span class="p">:</span> <span class="n">PathLike</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a model for finetuning with a pretrained backbone and a</span>
<span class="sd">        new head (randomly initialized). This method should load the backbone</span>
<span class="sd">        weights from the specified checkpoint and attach a freshly initialized</span>
<span class="sd">        head for the downstream task. User must handle the logic to load the</span>
<span class="sd">        backbone weights into the model&#39;s state dict.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        backbone_checkpoint_path : PathLike</span>
<span class="sd">            Path to the checkpoint containing pretrained backbone weights. The</span>
<span class="sd">            checkpoint must be compatible with the model architecture.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        L.LightningModule</span>
<span class="sd">            The model ready for finetuning (pretrained backbone, new head).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ModelInstantiator.load_model_from_checkpoint">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.ModelInstantiator.load_model_from_checkpoint">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_model_from_checkpoint</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">:</span> <span class="n">PathLike</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the full model (backbone and head) from a saved checkpoint.</span>
<span class="sd">        Typically used for resuming training, evaluation, or inference when the</span>
<span class="sd">        model must be restored in its entirety. In practice, the checkpoint</span>
<span class="sd">        should be one created using `create_model_and_load_backbone` or</span>
<span class="sd">        `create_model_randomly_initialized`.</span>
<span class="sd">        The checkpoint must be compatible with the model architecture.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        checkpoint_path : PathLike</span>
<span class="sd">            Path to the checkpoint file containing the full model state.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        L.LightningModule</span>
<span class="sd">            A Lightning model fully restored from checkpoint, ready for</span>
<span class="sd">            evaluation or inference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;load_model_from_checkpoint must be implemented in the subclass.&quot;</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ModelInformation">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.ModelInformation">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelInformation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Container for metadata related to a machine learning model configuration.</span>

<span class="sd">    This class stores essential information about a model&#39;s identity,</span>
<span class="sd">    architecture, data shapes, and output behavior. Such metadata is useful</span>
<span class="sd">    for tasks such as logging, reproducibility, automated evaluation, or</span>
<span class="sd">    dynamic behavior in pipelines.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        A unique identifier for the model configuration. Commonly used for</span>
<span class="sd">        logging, saving checkpoints, or experiment tracking.</span>

<span class="sd">    backbone_name : Optional[str], optional</span>
<span class="sd">        The name of the backbone architecture used in the model (e.g.,</span>
<span class="sd">        &quot;resnet50&quot;, &quot;vit-base&quot;). Useful for identifying model variants or</span>
<span class="sd">        tracking architectural differences.</span>

<span class="sd">    task_type : Optional[str], optional</span>
<span class="sd">        The task the model is designed for (e.g., &quot;classification&quot;,</span>
<span class="sd">        &quot;segmentation&quot;, &quot;detection&quot;). Enables downstream logic to adapt based</span>
<span class="sd">        on the task type.</span>

<span class="sd">    input_shape : Optional[Tuple[int, ...]], optional</span>
<span class="sd">        Expected shape of input tensors (excluding batch size), typically in</span>
<span class="sd">        the format (C, H, W) for image data. For example: (3, 224, 224) for an</span>
<span class="sd">        RGB image of size 224x224.</span>

<span class="sd">    output_shape : Optional[Tuple[int, ...]], optional</span>
<span class="sd">        Expected shape of model outputs (excluding batch size). Examples</span>
<span class="sd">        include:</span>
<span class="sd">            - (6, 224, 224) for semantic segmentation logits with 6 classes</span>
<span class="sd">            - (224, 224) for semantic segmentation predictions (argmax indices)</span>
<span class="sd">            - (6,) for classification logits (6 classes)</span>
<span class="sd">            - (1,) for classification predictions as class indices</span>

<span class="sd">    num_classes : Optional[int], optional</span>
<span class="sd">        Total number of classes the model is predicting. Primarily relevant for</span>
<span class="sd">        classification or segmentation tasks.</span>

<span class="sd">    return_logits : Optional[bool], optional</span>
<span class="sd">        If True, the model returns raw logits. If False, it returns</span>
<span class="sd">        post-processed class predictions (e.g., argmax indices or</span>
<span class="sd">        probabilities).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">backbone_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">task_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">input_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">output_shape</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">num_classes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">return_logits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="ModelConfig">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.ModelConfig">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ModelConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encapsulates the full configuration of a model for use in a training or</span>
<span class="sd">    inference pipeline.</span>

<span class="sd">    A `ModelConfig` brings together two key components:</span>

<span class="sd">    - `ModelInstantiator`: Responsible for creating the model in different</span>
<span class="sd">      modes (lazily instantiated):</span>
<span class="sd">        - From scratch (randomly initialized)</span>
<span class="sd">        - Finetuning (load pretrained backbone, new head)</span>
<span class="sd">        - From checkpoint (fully restored model)</span>

<span class="sd">    - `ModelInformation`: Contains descriptive metadata about the model such</span>
<span class="sd">      as input/output shapes, number of classes, backbone used, and task type.</span>

<span class="sd">    This class serves as the primary interface for managing and accessing</span>
<span class="sd">    model configuration throughout the lifecycle of training, evaluation, or</span>
<span class="sd">    deployment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">instantiator</span><span class="p">:</span> <span class="n">ModelInstantiator</span><span class="p">,</span>
        <span class="n">information</span><span class="p">:</span> <span class="n">ModelInformation</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a model configuration.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        instantiator : ModelInstantiator</span>
<span class="sd">            An instance responsible for constructing the model in various</span>
<span class="sd">            training modes (random init, load backbone, load full checkpoint).</span>
<span class="sd">            This enables lazy instantiation depending on the training phase.</span>

<span class="sd">        information : ModelInformation</span>
<span class="sd">            Metadata describing the model&#39;s architecture and behavior.</span>
<span class="sd">            Includes input/output shapes, task type, number of classes, and</span>
<span class="sd">            other relevant info useful for logging, validation, and downstream</span>
<span class="sd">            processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instantiator</span> <span class="o">=</span> <span class="n">instantiator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">information</span> <span class="o">=</span> <span class="n">information</span>

<div class="viewcode-block" id="ModelConfig.__str__">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.ModelConfig.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ModelConfig</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;├── Instantiator: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instantiator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="n">indent_text</span><span class="p">(</span><span class="n">tree_like_formating</span><span class="p">(</span><span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">information</span><span class="p">)),</span> <span class="n">spaces</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span></div>
</div>



<span class="c1"># -------- Functional interfaces --------</span>
<div class="viewcode-block" id="get_trainer">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.get_trainer">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_trainer</span><span class="p">(</span>
    <span class="n">log_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">max_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">limit_train_batches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit_val_batches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit_test_batches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit_predict_batches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">accelerator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">devices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
    <span class="n">num_nodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">progress_bar_refresh_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">enable_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">checkpoint_metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">precision</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;32-true&quot;</span><span class="p">,</span>
    <span class="n">accumulate_grad_batches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">deterministic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">benchmark</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">profiler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overfit_batches</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">sync_batchnorm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">L</span><span class="o">.</span><span class="n">Trainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates and configures a PyTorch Lightning Trainer instance.</span>

<span class="sd">    This function encapsulates all necessary options for flexible training,</span>
<span class="sd">    evaluation, or inference, including logging, checkpointing, device setup,</span>
<span class="sd">    precision, and more.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    log_dir : Path</span>
<span class="sd">        Directory path where logs and checkpoints will be saved.</span>

<span class="sd">    max_epochs : int, default=100</span>
<span class="sd">        Maximum number of epochs for training.</span>

<span class="sd">    limit_train_batches : int or float, optional</span>
<span class="sd">        Limit on the number of training batches per epoch. Can be an integer</span>
<span class="sd">        (absolute number) or a float (fraction of total batches).</span>

<span class="sd">    limit_val_batches : int or float, optional</span>
<span class="sd">        Limit on the number of validation batches per epoch.</span>

<span class="sd">    limit_test_batches : int or float, optional</span>
<span class="sd">        Limit on the number of test batches per epoch.</span>

<span class="sd">    limit_predict_batches : int or float, optional</span>
<span class="sd">        Limit on the number of prediction batches.</span>

<span class="sd">    accelerator : str, default=&quot;auto&quot;</span>
<span class="sd">        Hardware accelerator to use (e.g., &quot;gpu&quot;, &quot;cpu&quot;, &quot;tpu&quot;, &quot;auto&quot;).</span>

<span class="sd">    strategy : str, default=&quot;auto&quot;</span>
<span class="sd">        Distributed training strategy (e.g., &quot;ddp&quot;, &quot;deepspeed&quot;, etc.).</span>

<span class="sd">    devices : int, list of int, or str, optional, default=&quot;auto&quot;</span>
<span class="sd">        Devices to use for training (e.g., 1, [0,1], &quot;auto&quot;).</span>

<span class="sd">    num_nodes : int, default=1</span>
<span class="sd">        Number of nodes to use for distributed training.</span>

<span class="sd">    progress_bar_refresh_rate : int, default=1</span>
<span class="sd">        Frequency (in steps) at which the progress bar is updated.</span>
<span class="sd">        Set to 0 to disable.</span>

<span class="sd">    enable_logging : bool, default=True</span>
<span class="sd">        Whether to enable CSV logging.</span>

<span class="sd">    checkpoint_metrics : list of dict, optional</span>
<span class="sd">        List of dictionaries containing checkpoint configurations. Each</span>
<span class="sd">        dictionary should specify &quot;monitor&quot;, &quot;mode&quot;, and &quot;filename&quot;.</span>

<span class="sd">    precision : str, default=&quot;32-true&quot;</span>
<span class="sd">        Numerical precision to use during training (e.g., 32-true, 16-mixed).</span>

<span class="sd">    accumulate_grad_batches : int, default=1</span>
<span class="sd">        Number of batches for which gradients should be accumulated before</span>
<span class="sd">        performing an optimizer step.</span>

<span class="sd">    deterministic : bool, default=False</span>
<span class="sd">        If True, sets deterministic behavior for reproducibility.</span>

<span class="sd">    benchmark : bool, default=True</span>
<span class="sd">        Enables the cudnn.benchmark flag for optimized performance on fixed</span>
<span class="sd">        input sizes.</span>

<span class="sd">    profiler : str, optional</span>
<span class="sd">        Enables performance profiling (e.g., &quot;simple&quot;, &quot;advanced&quot;).</span>

<span class="sd">    overfit_batches : int or float, default=0.0</span>
<span class="sd">        Uses a fraction or number of batches for both training and validation</span>
<span class="sd">        to quickly debug overfitting behavior.</span>

<span class="sd">    sync_batchnorm : bool, default=False</span>
<span class="sd">        Synchronizes batch norm layers across devices during distributed</span>
<span class="sd">        training.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    L.Trainer</span>
<span class="sd">        A configured PyTorch Lightning Trainer instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">enable_logging</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">CSVLogger</span><span class="p">(</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="n">log_dir</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">log_dir</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">log_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">enable_checkpointing</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">checkpoint_metrics</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ckpt_metric</span> <span class="ow">in</span> <span class="n">checkpoint_metrics</span><span class="p">:</span>
            <span class="n">ckpt_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="n">ckpt_metric</span><span class="p">[</span><span class="s2">&quot;monitor&quot;</span><span class="p">],</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="n">ckpt_metric</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">],</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">ckpt_metric</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">],</span>
                <span class="s2">&quot;save_last&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;enable_version_counter&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ModelCheckpoint</span><span class="p">(</span><span class="o">**</span><span class="n">ckpt_kwargs</span><span class="p">))</span>

        <span class="n">enable_checkpointing</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">enable_checkpointing</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">enable_progress_bar</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">log_every_n_steps</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">progress_bar_refresh_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">enable_progress_bar</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ProgressBar</span><span class="p">(</span><span class="n">refresh_rate</span><span class="o">=</span><span class="n">progress_bar_refresh_rate</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">L</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
        <span class="n">accelerator</span><span class="o">=</span><span class="n">accelerator</span><span class="p">,</span>
        <span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
        <span class="n">enable_checkpointing</span><span class="o">=</span><span class="n">enable_checkpointing</span><span class="p">,</span>
        <span class="n">enable_progress_bar</span><span class="o">=</span><span class="n">enable_progress_bar</span><span class="p">,</span>
        <span class="n">enable_model_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">log_every_n_steps</span><span class="o">=</span><span class="n">log_every_n_steps</span><span class="p">,</span>
        <span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs</span><span class="p">,</span>
        <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
        <span class="n">num_nodes</span><span class="o">=</span><span class="n">num_nodes</span><span class="p">,</span>
        <span class="n">limit_train_batches</span><span class="o">=</span><span class="n">limit_train_batches</span><span class="p">,</span>
        <span class="n">limit_val_batches</span><span class="o">=</span><span class="n">limit_val_batches</span><span class="p">,</span>
        <span class="n">limit_test_batches</span><span class="o">=</span><span class="n">limit_test_batches</span><span class="p">,</span>
        <span class="n">limit_predict_batches</span><span class="o">=</span><span class="n">limit_predict_batches</span><span class="p">,</span>
        <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">accumulate_grad_batches</span><span class="o">=</span><span class="n">accumulate_grad_batches</span><span class="p">,</span>
        <span class="n">deterministic</span><span class="o">=</span><span class="n">deterministic</span><span class="p">,</span>
        <span class="n">benchmark</span><span class="o">=</span><span class="n">benchmark</span><span class="p">,</span>
        <span class="n">inference_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">profiler</span><span class="o">=</span><span class="n">profiler</span><span class="p">,</span>
        <span class="n">overfit_batches</span><span class="o">=</span><span class="n">overfit_batches</span><span class="p">,</span>
        <span class="n">sync_batchnorm</span><span class="o">=</span><span class="n">sync_batchnorm</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="save_predictions">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.save_predictions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_predictions</span><span class="p">(</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">],</span> <span class="n">path</span><span class="p">:</span> <span class="n">PathLike</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save predictions to a given path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    predictions : Union[np.ndarray, torch.Tensor]</span>
<span class="sd">        The prediction data to save.</span>
<span class="sd">    path : PathLike</span>
<span class="sd">        The path where the predictions will be saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Predictions must be a numpy array.&quot;</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;npz&quot;</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predictions saved to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_predictions">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.load_predictions">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_predictions</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">PathLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a prediction from a given path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : PathLike</span>
<span class="sd">        The path to the prediction file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        The loaded prediction data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot;npz&quot;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;predictions&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No &#39;predictions&#39; key found in the npz file.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="save_results">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.save_results">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_results</span><span class="p">(</span><span class="n">results</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">PathLike</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save results to a given path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    results : pd.DataFrame</span>
<span class="sd">        The results data to save.</span>
<span class="sd">    path : PathLike</span>
<span class="sd">        The path where the results will be saved.</span>
<span class="sd">    index : bool, optional</span>
<span class="sd">        Whether to save the index of the DataFrame, by default False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results saved to </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_results">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.load_results">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_results</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">PathLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load results from a given path.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : PathLike</span>
<span class="sd">        The path to the results file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        The loaded results data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>



<div class="viewcode-block" id="perform_train">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.perform_train">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">perform_train</span><span class="p">(</span>
    <span class="n">data_module</span><span class="p">:</span> <span class="n">MinervaDataModule</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">,</span>
    <span class="n">trainer</span><span class="p">:</span> <span class="n">L</span><span class="o">.</span><span class="n">Trainer</span><span class="p">,</span>
    <span class="n">resume_from_ckpt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train the model using the provided data module and trainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_module : MinervaDataModule</span>
<span class="sd">        The data module containing the training and validation datasets.</span>
<span class="sd">    model : L.LightningModule</span>
<span class="sd">        The model to be trained.</span>
<span class="sd">    trainer : L.Trainer</span>
<span class="sd">        The trainer instance to use for training.</span>
<span class="sd">    resume_from_ckpt : Optional[PathLike], optional</span>
<span class="sd">        A path to a checkpoint in which to resume training. If None, training</span>
<span class="sd">        starts from scratch. By default None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    L.LightningModule</span>
<span class="sd">        The trained model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_module</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="o">=</span><span class="n">resume_from_ckpt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span></div>



<div class="viewcode-block" id="perform_predict">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.perform_predict">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">perform_predict</span><span class="p">(</span>
    <span class="n">data_module</span><span class="p">:</span> <span class="n">MinervaDataModule</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">,</span>
    <span class="n">trainer</span><span class="p">:</span> <span class="n">L</span><span class="o">.</span><span class="n">Trainer</span><span class="p">,</span>
    <span class="n">squeeze</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform predictions using the provided data module and trainer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_module : MinervaDataModule</span>
<span class="sd">        The data module containing the dataset for predictions.</span>
<span class="sd">    model : L.LightningModule</span>
<span class="sd">        The model to be used for predictions.</span>
<span class="sd">    trainer : L.Trainer</span>
<span class="sd">        The trainer instance to use for predictions.</span>
<span class="sd">    squeeze : bool, optional</span>
<span class="sd">        If True, squeeze the predictions to remove single-dimensional entries</span>
<span class="sd">        from the shape of the predictions (except from first dimension). By</span>
<span class="sd">        default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        The predictions as a numpy array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">list_of_predicted_batches</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data_module</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">list_of_predicted_batches</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="n">predictions_dimensions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">squeeze</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions_dimensions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Squeeze all except the first dimension (batch dimension)</span>
        <span class="n">predictions_dimensions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">predictions_dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">predictions_dimensions</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">predictions</span></div>



<div class="viewcode-block" id="perform_evaluation">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.perform_evaluation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">perform_evaluation</span><span class="p">(</span>
    <span class="n">evaluation_metrics</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torchmetrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">],</span>
    <span class="n">data_module</span><span class="p">:</span> <span class="n">MinervaDataModule</span><span class="p">,</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">argmax_axis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">per_sample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">device</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluates predictions using provided evaluation metrics and a data module</span>

<span class="sd">    This function compares predicted values against ground truth labels from</span>
<span class="sd">    a prediction dataset. It supports both aggregate evaluation over the entire</span>
<span class="sd">    dataset and per-sample evaluation. Metrics should be compatible with</span>
<span class="sd">    `torchmetrics`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    evaluation_metrics : dict of str to torchmetrics.Metric</span>
<span class="sd">        A dictionary mapping metric names to `torchmetrics.Metric` instances.</span>

<span class="sd">    data_module : MinervaDataModule</span>
<span class="sd">        A data module that contains the `predict_dataset` used for evaluation.</span>

<span class="sd">    predictions : np.ndarray</span>
<span class="sd">        An array of predictions generated by the model.</span>

<span class="sd">    argmax_axis : int, optional</span>
<span class="sd">        If provided, applies `torch.argmax` along this axis to the predictions</span>
<span class="sd">        before metric evaluation.</span>

<span class="sd">    per_sample : bool, default=False</span>
<span class="sd">        If True, computes metrics individually for each sample. Otherwise,</span>
<span class="sd">        evaluates metrics over the entire dataset in batches.</span>

<span class="sd">    batch_size : int, default=1</span>
<span class="sd">        Batch size used for evaluation when `per_sample` is False.</span>

<span class="sd">    device : str, default=&quot;cpu&quot;</span>
<span class="sd">        The device (e.g., &quot;cpu&quot;, &quot;cuda&quot;) on which metric computations will run.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        A DataFrame containing computed metric values. If `per_sample` is True,</span>
<span class="sd">        each row corresponds to one sample. Otherwise, a single-row summary is</span>
<span class="sd">        returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">data_module</span><span class="o">.</span><span class="n">predict_dataset</span>
    <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No predict dataset found in the data module. &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;Please provide a predict dataset to perform evaluation.&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">evaluation_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">torchmetrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Metric </span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2"> is not a valid torchmetrics.Metric.&quot;</span>
            <span class="p">)</span>
        <span class="n">metric</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">per_sample</span><span class="p">:</span>
        <span class="c1"># ys -&gt; numpy array -&gt; torch tensor (to keep dtype)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">))])</span>  <span class="c1"># type: ignore</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y_hat</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">predictions</span>
        <span class="p">)</span>
        <span class="c1"># Perform argmax if needed</span>
        <span class="k">if</span> <span class="n">argmax_axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_hat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">argmax_axis</span><span class="p">)</span>

        <span class="c1"># Compute metrics</span>
        <span class="n">y_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">y</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">y_hat_dataloader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">y_hat</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">y_batch</span><span class="p">,</span> <span class="n">y_hat_batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">y_dataloader</span><span class="p">,</span> <span class="n">y_hat_dataloader</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Computing metrics&quot;</span><span class="p">,</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">y_dataloader</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">y_batch</span> <span class="o">=</span> <span class="n">y_batch</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">y_hat_batch</span> <span class="o">=</span> <span class="n">y_hat_batch</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">evaluation_metrics</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">metric</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y_hat_batch</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>

        <span class="c1"># Compute all metrics</span>
        <span class="n">result_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sample&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">evaluation_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">result_metrics</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># Convert to DataFrame</span>
        <span class="n">result_metrics_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">result_metrics</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result_metrics_df</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">)),</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">predictions</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Computing metrics (per sample)&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;sample&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
            <span class="n">prediction</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">label</span>
            <span class="c1"># int, float, bool or str</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">y_hat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prediction</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">y_hat</span> <span class="o">=</span> <span class="n">prediction</span>
            <span class="c1"># int, float, bool or str</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_hat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prediction</span><span class="p">))</span>

            <span class="c1"># Perform argmax if needed</span>
            <span class="k">if</span> <span class="n">argmax_axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">y_hat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y_hat</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="n">argmax_axis</span><span class="p">)</span>

            <span class="n">y</span><span class="p">,</span> <span class="n">y_hat</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">y</span><span class="p">,</span> <span class="n">y_hat</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">y_hat</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># Compute metrics</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">evaluation_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">metric</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">metric</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># Convert to DataFrame</span>
        <span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results_df</span></div>



<div class="viewcode-block" id="Experiment">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Experiment</span><span class="p">(</span><span class="n">Pipeline</span><span class="p">):</span>
    <span class="n">NUM_DEBUG_EPOCHS</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">NUM_DEBUG_BATCHES</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="c1"># Base parameters</span>
        <span class="n">experiment_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">model_config</span><span class="p">:</span> <span class="n">ModelConfig</span><span class="p">,</span>
        <span class="n">data_module</span><span class="p">:</span> <span class="n">MinervaDataModule</span><span class="p">,</span>
        <span class="c1"># Logging and checkpointing parameters</span>
        <span class="n">pretrained_backbone_ckpt_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">root_log_dir</span><span class="p">:</span> <span class="n">PathLike</span> <span class="o">=</span> <span class="s2">&quot;./logs&quot;</span><span class="p">,</span>
        <span class="n">execution_id</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">checkpoint_metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># Trainer-related parameters</span>
        <span class="n">max_epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">accelerator</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpu&quot;</span><span class="p">,</span>
        <span class="n">devices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
        <span class="n">num_nodes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">limit_train_batches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_val_batches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_test_batches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">limit_predict_batches</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># Prediction parameters</span>
        <span class="n">evaluation_metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torchmetrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">per_sample_evaluation_metrics</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torchmetrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># Other parameters</span>
        <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">progress_bar_refresh_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">profiler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_predictions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">save_results</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">add_last_checkpoint</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An experiment is a pipeline that contains all the parameters needed</span>
<span class="sd">        to train and evaluate a model, as well as to manage the logging,</span>
<span class="sd">        checkpointing, prediction, and results processes in a coherent way.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        experiment_name : str</span>
<span class="sd">            The name of the experiment. This name will be used to create a</span>
<span class="sd">            directory for the experiment in the log directory.</span>
<span class="sd">        model_config : ModelConfig</span>
<span class="sd">            The model configuration. This object contains the model instantiator</span>
<span class="sd">            and the model information.</span>
<span class="sd">        data_module : MinervaDataModule</span>
<span class="sd">            The data module. This object contains the training, validation, and</span>
<span class="sd">            test datasets, as well as the data loaders. For now, datasets must</span>
<span class="sd">            return a 2 element tuple (input, label) for each sample.</span>
<span class="sd">        pretrained_backbone_ckpt_path : Optional[PathLike], optional</span>
<span class="sd">            The path to the pretrained backbone checkpoint. This is used to</span>
<span class="sd">            finetune the model. If None, the model will be trained from</span>
<span class="sd">            scratch. This parameter handles the lazy instantiation of the model</span>
<span class="sd">            and calls `create_model_and_load_backbone` method of the model</span>
<span class="sd">            instantiator if `pretrained_backbone_ckpt_path` is not None or</span>
<span class="sd">            `create_model_randomly_initialized` method if it is None. By</span>
<span class="sd">            default None</span>
<span class="sd">        root_log_dir : PathLike, optional</span>
<span class="sd">            Root directory for logging and checkpoints. This directory will be</span>
<span class="sd">            used to create a subdirectory for the experiment. By default ./logs</span>
<span class="sd">        execution_id : Union[str, int], optional</span>
<span class="sd">            The execution ID for the experiment. This ID will be used to create</span>
<span class="sd">            a subdirectory for the experiment in the log directory. This is</span>
<span class="sd">            useful when running the experiment multiple times with the same</span>
<span class="sd">            parameters. By default 0</span>
<span class="sd">        checkpoint_metrics : Optional[List[Dict[str, str]]], optional</span>
<span class="sd">            The checkpoint metrics. This is a list of dictionaries that contain</span>
<span class="sd">            the checkpoint metrics. Each dictionary must contain the keys</span>
<span class="sd">            &quot;monitor&quot;, &quot;mode&quot;, and &quot;filename&quot;. The &quot;monitor&quot; key is the name of</span>
<span class="sd">            the metric to monitor, the &quot;mode&quot; key is the mode of the metric</span>
<span class="sd">            (&quot;min&quot; or &quot;max&quot;), and the &quot;filename&quot; key is the name of the</span>
<span class="sd">            checkpoint file. The &quot;monitor&quot; key can be None if the checkpoint is</span>
<span class="sd">            the last one. By default None</span>
<span class="sd">        max_epochs : int, optional</span>
<span class="sd">            Number of epochs to train the model. This parameter is passed to the</span>
<span class="sd">            `get_trainer` function. By default 100.</span>
<span class="sd">        accelerator : str, optional</span>
<span class="sd">            The accelerator to use for training. This parameter is passed to the</span>
<span class="sd">            `get_trainer` function. By default &quot;gpu&quot;. Possible values are</span>
<span class="sd">            &quot;cpu&quot;, &quot;gpu&quot;, &quot;tpu&quot;, &quot;ipu&quot;, &quot;hpu&quot;, &quot;mps&quot;, &quot;auto&quot;. If &quot;auto&quot; is</span>
<span class="sd">            selected, the accelerator will be automatically selected based on</span>
<span class="sd">            the available hardware. By default &quot;gpu&quot;</span>
<span class="sd">        devices : Optional[Union[int, list[int], str]], optional</span>
<span class="sd">            Number of accelerators to use for training. This parameter is</span>
<span class="sd">            passed to the `get_trainer` function. By default 1.</span>
<span class="sd">        strategy : str, optional</span>
<span class="sd">            Strategy to use for distributed training. This parameter is passed</span>
<span class="sd">            to the `get_trainer` function. By default &quot;auto&quot;.</span>
<span class="sd">        num_nodes : int, optional</span>
<span class="sd">            Number of nodes to use for distributed training. This parameter is</span>
<span class="sd">            passed to the `get_trainer` function. By default 1.</span>
<span class="sd">        limit_train_batches : Optional[Union[int, float]], optional</span>
<span class="sd">            Limit the number of training batches to use. This parameter is</span>
<span class="sd">            passed to the `get_trainer` function. By default None. If None, all</span>
<span class="sd">            batches will be used. If an integer is provided, it will be the</span>
<span class="sd">            absolute number of batches. If a float is provided, it will be the</span>
<span class="sd">            fraction of the total number of batches. For example, 0.1 means 10%</span>
<span class="sd">            of the training batches will be used.</span>
<span class="sd">        limit_val_batches : Optional[Union[int, float]], optional</span>
<span class="sd">            Limit the number of validation batches to use. This parameter is</span>
<span class="sd">            passed to the `get_trainer` function. By default None. If None, all</span>
<span class="sd">            batches will be used. If an integer is provided, it will be the</span>
<span class="sd">            absolute number of batches. If a float is provided, it will be the</span>
<span class="sd">            fraction of the total number of batches. For example, 0.1 means 10%</span>
<span class="sd">            of the validation batches will be used.</span>
<span class="sd">        limit_test_batches : Optional[Union[int, float]], optional</span>
<span class="sd">            Limit the number of test batches to use. This parameter is</span>
<span class="sd">            passed to the `get_trainer` function. By default None. If None, all</span>
<span class="sd">            batches will be used. If an integer is provided, it will be the</span>
<span class="sd">            absolute number of batches. If a float is provided, it will be the</span>
<span class="sd">            fraction of the total number of batches. For example, 0.1 means 10%</span>
<span class="sd">            of the test batches will be used.</span>
<span class="sd">        limit_predict_batches : Optional[Union[int, float]], optional</span>
<span class="sd">            Limit the number of prediction batches to use. This parameter is</span>
<span class="sd">            passed to the `get_trainer` function. By default None. If None, all</span>
<span class="sd">            batches will be used. If an integer is provided, it will be the</span>
<span class="sd">            absolute number of batches. If a float is provided, it will be the</span>
<span class="sd">            fraction of the total number of batches. For example, 0.1 means 10%</span>
<span class="sd">            of the prediction batches will be used.</span>
<span class="sd">        evaluation_metrics : Optional[Dict[str, torchmetrics.Metric]], optional</span>
<span class="sd">            A dictionary of evaluation metrics to use for the predictions. The</span>
<span class="sd">            keys are the names of the metrics and the values are the</span>
<span class="sd">            `torchmetrics.Metric` objects. These metrics are calculated using</span>
<span class="sd">            all the predictions. By default None.</span>
<span class="sd">        per_sample_evaluation_metrics : Optional[ Dict[str, torchmetrics.Metric] ], optional</span>
<span class="sd">            A dictionary of evaluation metrics to use for the predictions. The</span>
<span class="sd">            keys are the names of the metrics and the values are the</span>
<span class="sd">            `torchmetrics.Metric` objects. These metrics are calculated using</span>
<span class="sd">            each prediction separately, that is, applyied per sample. By</span>
<span class="sd">            default None.</span>
<span class="sd">        seed : Optional[int], optional</span>
<span class="sd">            The seed to use for the experiment, by default None</span>
<span class="sd">        progress_bar_refresh_rate : int, optional</span>
<span class="sd">            The refresh rate of the progress bar (in batches). If 0, the</span>
<span class="sd">            progress bar is disabled. If 1, the progress bar is updated every</span>
<span class="sd">            batch. By default 1</span>
<span class="sd">        profiler : Optional[str], optional</span>
<span class="sd">            A profiler to use for the experiment. This parameter is passed to</span>
<span class="sd">            the `get_trainer` function. By default None.</span>
<span class="sd">        save_predictions : bool, optional</span>
<span class="sd">            If True, the predictions will be saved to the log directory. By</span>
<span class="sd">            default True</span>
<span class="sd">        save_results : bool, optional</span>
<span class="sd">            If True, the results will be saved to the log directory. By</span>
<span class="sd">            default True</span>
<span class="sd">        add_last_checkpoint : bool, optional</span>
<span class="sd">            If True, the last checkpoint will be added to the list of checkpoint</span>
<span class="sd">            metrics. By default True.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the checkpoint metrics are not valid or do not contain the</span>
<span class="sd">            required keys.</span>

<span class="sd">        Notes</span>
<span class="sd">        ------</span>
<span class="sd">        - This class assumes that the `MinervaDataModule` class returns a</span>
<span class="sd">            (input, label) tuple for each sample in the dataset. The input is</span>
<span class="sd">            the data and the label is the ground truth/target.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ------- Base parameters -------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_name</span> <span class="o">=</span> <span class="n">experiment_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_module</span> <span class="o">=</span> <span class="n">data_module</span>

        <span class="c1"># ------- Logging and checkpointing parameters -------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_backbone_ckpt_path</span> <span class="o">=</span> <span class="n">pretrained_backbone_ckpt_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root_log_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">root_log_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">execution_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_metrics</span> <span class="o">=</span> <span class="n">checkpoint_metrics</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="c1"># Check if checkpoint metrics are valid</span>
        <span class="k">for</span> <span class="n">ckpt_metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_metrics</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ckpt_metric</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Checkpoint metric must be a dictionary.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;monitor&quot;</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ckpt_metric</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkpoint metric must contain a &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; key.&quot;</span><span class="p">)</span>
        <span class="c1"># Add the &quot;last&quot; checkpoint metric if not already present</span>
        <span class="k">if</span> <span class="n">add_last_checkpoint</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                <span class="n">ckpt_metric</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;last&quot;</span>
                <span class="k">for</span> <span class="n">ckpt_metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_metrics</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;last&quot;</span><span class="p">}</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>

        <span class="c1"># -------  Trainer-related parameters -------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="n">max_epochs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span> <span class="o">=</span> <span class="n">accelerator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">devices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">=</span> <span class="n">num_nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_train_batches</span> <span class="o">=</span> <span class="n">limit_train_batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_val_batches</span> <span class="o">=</span> <span class="n">limit_val_batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_test_batches</span> <span class="o">=</span> <span class="n">limit_test_batches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_predict_batches</span> <span class="o">=</span> <span class="n">limit_predict_batches</span>

        <span class="c1"># ------- Prediction parameters -------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span> <span class="o">=</span> <span class="n">evaluation_metrics</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_sample_evaluation_metrics</span> <span class="o">=</span> <span class="n">per_sample_evaluation_metrics</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="c1"># ------- Other parameters -------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar_refresh_rate</span> <span class="o">=</span> <span class="n">progress_bar_refresh_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span> <span class="o">=</span> <span class="n">profiler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_predictions</span> <span class="o">=</span> <span class="n">save_predictions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="n">save_results</span>

        <span class="c1"># ------- Initialize the pipeline -------</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_log_dir</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_name</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_module</span><span class="o">.</span><span class="n">dataset_name</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">name</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution_id</span>
        <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">log_dir</span><span class="o">=</span><span class="n">log_dir</span><span class="p">,</span>
            <span class="n">cache_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">save_run_status</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
            <span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;model_config&quot;</span><span class="p">,</span> <span class="s2">&quot;data_module&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_dir</span> <span class="o">=</span> <span class="n">log_dir</span> <span class="o">/</span> <span class="s2">&quot;checkpoints&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_predictions_dir</span> <span class="o">=</span> <span class="n">log_dir</span> <span class="o">/</span> <span class="s2">&quot;predictions&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results_dir</span> <span class="o">=</span> <span class="n">log_dir</span> <span class="o">/</span> <span class="s2">&quot;results&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_metrics_path</span> <span class="o">=</span> <span class="n">log_dir</span> <span class="o">/</span> <span class="s2">&quot;metrics.csv&quot;</span>

    <span class="c1"># ------------ Acessors ------------</span>
    <span class="c1"># Here we have acess to:</span>
    <span class="c1"># - checkpoint paths</span>
    <span class="c1"># - metrics and metrics path</span>
    <span class="c1"># - prediction paths</span>
    <span class="c1"># - results and results path</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">checkpoint_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of checkpoint paths for the experiment.</span>

<span class="sd">        The keys are the checkpoint names, and the values are the corresponding</span>
<span class="sd">        paths to the checkpoints.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Path]</span>
<span class="sd">            A dictionary mapping checkpoint names to their respective paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="p">:</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.ckpt&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">()}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">training_metrics_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The path to the training metrics file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[Path]</span>
<span class="sd">            The path to the metrics file if it exists, otherwise None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_metrics_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_metrics_path</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">training_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the training metrics as a pandas DataFrame.</span>
<span class="sd">        If the metrics file does not exist, returns None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[pd.DataFrame]</span>
<span class="sd">            A DataFrame containing the training metrics.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if the metrics file exists and is a file</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_metrics_path</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_training_metrics_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">prediction_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of prediction paths for the experiment.</span>

<span class="sd">        The keys are the prediction names, and the values are the corresponding</span>
<span class="sd">        paths to the predictions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Path]</span>
<span class="sd">            A dictionary mapping prediction names to their respective paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="p">:</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictions_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.npy&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">()}</span>

<div class="viewcode-block" id="Experiment.load_predictions_of_ckpt">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment.load_predictions_of_ckpt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_predictions_of_ckpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load predictions from a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the prediction file (without extension).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            The loaded predictions as a numpy array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">load_predictions</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Prediction file &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_predictions_dir</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">results_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a dictionary of results paths for the experiment.</span>

<span class="sd">        The keys are the result names, and the values are the corresponding</span>
<span class="sd">        paths to the results.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Path]</span>
<span class="sd">            A dictionary mapping result names to their respective paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">p</span><span class="o">.</span><span class="n">stem</span><span class="p">:</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.csv&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">()}</span>

<div class="viewcode-block" id="Experiment.load_results_of_ckpt">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment.load_results_of_ckpt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_results_of_ckpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load results from a file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            The name of the result file (without extension).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The loaded results as a pandas DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_paths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">load_results</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results file &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_results_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="c1"># ---------- Trainer ---------</span>

<div class="viewcode-block" id="Experiment._trainer_parameters">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment._trainer_parameters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_trainer_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">enable_logging</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the parameters for the trainer based on the current on debug</span>
<span class="sd">        and logging settings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        enable_logging : bool, optional</span>
<span class="sd">            If True, logging will be enabled, by default True</span>
<span class="sd">        debug : bool, optional</span>
<span class="sd">            If True,  model will be trained with a few batches and for a few</span>
<span class="sd">            epochs only. Logging will always be disabled, by default False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Any]</span>
<span class="sd">            All the parameters for the `get_trainer` function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;log_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span>
            <span class="s2">&quot;max_epochs&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_DEBUG_EPOCHS</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="p">,</span>
            <span class="s2">&quot;limit_train_batches&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NUM_DEBUG_BATCHES</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_train_batches</span>
            <span class="p">),</span>
            <span class="s2">&quot;limit_val_batches&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NUM_DEBUG_BATCHES</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_val_batches</span>
            <span class="p">),</span>
            <span class="s2">&quot;limit_test_batches&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NUM_DEBUG_BATCHES</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_test_batches</span>
            <span class="p">),</span>
            <span class="s2">&quot;limit_predict_batches&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">NUM_DEBUG_BATCHES</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit_predict_batches</span>
            <span class="p">),</span>
            <span class="s2">&quot;accelerator&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="p">,</span>
            <span class="s2">&quot;strategy&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
            <span class="s2">&quot;devices&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="p">,</span>
            <span class="s2">&quot;num_nodes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span>
            <span class="s2">&quot;progress_bar_refresh_rate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_bar_refresh_rate</span><span class="p">,</span>
            <span class="s2">&quot;enable_logging&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="n">enable_logging</span><span class="p">,</span>
            <span class="s2">&quot;checkpoint_metrics&quot;</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">debug</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_metrics</span><span class="p">,</span>
            <span class="s2">&quot;precision&quot;</span><span class="p">:</span> <span class="s2">&quot;32-true&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deterministic&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;benchmark&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;profiler&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">profiler</span><span class="p">,</span>
        <span class="p">}</span></div>


    <span class="c1"># ---------- FIT Experiment methods ---------</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__typing_string</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;shape=</span><span class="si">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;scalar with type=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="Experiment._print_train_summary">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment._print_train_summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_print_train_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="n">L</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">,</span>
        <span class="n">trainer_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">resume_from_ckpt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Experiment: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;(DEBUG)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">debug</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span>
                <span class="mi">80</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

        <span class="c1">#  ------------ Model info ------------</span>
        <span class="n">finetune_backbone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_backbone_ckpt_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">total_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
        <span class="n">trainable_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;🧠 Model&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Finetune: </span><span class="si">{</span><span class="s1">&#39;Yes&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">finetune_backbone</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;No&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">finetune_backbone</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;   |    └── Pretrained Backbone Checkpoint: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pretrained_backbone_ckpt_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Resumed From: </span><span class="si">{</span><span class="n">resume_from_ckpt</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;Beginning&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Expected Input Shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">input_shape</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Expected Output Shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">output_shape</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Total Params: </span><span class="si">{</span><span class="n">total_params</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;   └── Trainable Params: </span><span class="si">{</span><span class="n">trainable_params</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">trainable_params</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total_params</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   └── Trainable Params: 0 (0.00%)&quot;</span><span class="p">)</span>

        <span class="c1"># ------------ Dataset info ------------</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📊 Dataset&quot;</span><span class="p">)</span>
        <span class="n">train_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_module</span><span class="o">.</span><span class="n">train_dataset</span>
        <span class="n">val_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_module</span><span class="o">.</span><span class="n">val_dataset</span>
        <span class="k">if</span> <span class="n">train_data</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Train Samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   |   ├── Input Shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__typing_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   |   └── Label Shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__typing_string</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   ├── Train Dataset: None&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val_data</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">val_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   └── Validation Samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">val_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       ├── Input Shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__typing_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       └── Label Shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__typing_string</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   └── Validation Dataset: None&quot;</span><span class="p">)</span>

        <span class="c1"># ------------ Logging &amp; checkpoints ------------</span>
        <span class="n">ckpt_filenames</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.ckpt&quot;</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_metrics</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">checkpoints_exist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_paths</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">💾 Logging &amp; Checkpoints&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Log Dir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Metrics Path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_training_metrics_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   └── Checkpoints Dir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">checkpoints_exist</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       ├── Files: </span><span class="si">{</span><span class="n">ckpt_filenames</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       └── ⚠️ Existing checkpoints found! It will be overwritten!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       └── Files: </span><span class="si">{</span><span class="n">ckpt_filenames</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ------------ Trainer configuration ------------</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚙️ Trainer Config&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Max Epochs: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Train Batches: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;limit_train_batches&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Accelerator: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;accelerator&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Strategy: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Devices: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Num Nodes: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   └── Seed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Experiment._train_model">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment._train_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_train_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">resume_from_ckpt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">print_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">data_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_module</span>

        <span class="c1"># If pre-trained backbone is provided, load the model with the</span>
        <span class="c1"># pre-trained backbone (usually for finetuning)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_backbone_ckpt_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">instantiator</span><span class="o">.</span><span class="n">create_model_and_load_backbone</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_backbone_ckpt_path</span>
            <span class="p">)</span>
        <span class="c1"># If no pre-trained backbone is provided, create a model with</span>
        <span class="c1"># randomly initialized backbone and head (full supervised training)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">instantiator</span><span class="o">.</span><span class="n">create_model_randomly_initialized</span><span class="p">()</span>

        <span class="c1"># Get the trainer</span>
        <span class="n">trainer_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trainer_parameters</span><span class="p">(</span>
            <span class="n">enable_logging</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">trainer</span> <span class="o">=</span> <span class="n">get_trainer</span><span class="p">(</span><span class="o">**</span><span class="n">trainer_params</span><span class="p">)</span>

        <span class="c1"># Check if need to resume from a checkpoint</span>
        <span class="n">checkpoints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_paths</span>
        <span class="k">if</span> <span class="n">resume_from_ckpt</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resume_from_ckpt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">checkpoints</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Checkpoint &#39;</span><span class="si">{</span><span class="n">resume_from_ckpt</span><span class="si">}</span><span class="s2">&#39; not found in </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">checkpoints</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">resume_from_ckpt</span> <span class="o">=</span> <span class="n">checkpoints</span><span class="p">[</span><span class="n">resume_from_ckpt</span><span class="p">]</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Print the training summary</span>
        <span class="k">if</span> <span class="n">print_summary</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_print_train_summary</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">trainer_params</span><span class="o">=</span><span class="n">trainer_params</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
                <span class="n">resume_from_ckpt</span><span class="o">=</span><span class="n">resume_from_ckpt</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Train the model</span>
        <span class="n">perform_train</span><span class="p">(</span>
            <span class="n">data_module</span><span class="o">=</span><span class="n">data_module</span><span class="p">,</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">trainer</span><span class="o">=</span><span class="n">trainer</span><span class="p">,</span>
            <span class="n">resume_from_ckpt</span><span class="o">=</span><span class="n">resume_from_ckpt</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;data_module&quot;</span><span class="p">:</span> <span class="n">data_module</span><span class="p">,</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">,</span>
            <span class="s2">&quot;trainer&quot;</span><span class="p">:</span> <span class="n">trainer</span><span class="p">,</span>
            <span class="s2">&quot;log_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">,</span>
            <span class="s2">&quot;metrics_path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_metrics_path</span><span class="p">,</span>
            <span class="s2">&quot;checkpoints&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_paths</span><span class="p">,</span>
        <span class="p">}</span></div>


    <span class="c1"># ---------- EVALUATE Experiment methods ---------</span>
<div class="viewcode-block" id="Experiment._print_evaluation_summary">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment._print_evaluation_summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_print_evaluation_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">trainer_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ckpt_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">predictions_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">results_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PathLike</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Evaluation: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">ckpt_path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">) </span><span class="si">{</span><span class="s1">&#39;(DEBUG)&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">debug</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span>
                <span class="mi">80</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

        <span class="c1"># ------------ Checkpoint Info ------------</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;💾 Checkpoint&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Checkpoint Path: </span><span class="si">{</span><span class="n">ckpt_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   └── Predictions Path: </span><span class="si">{</span><span class="n">predictions_path</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;Not saved&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># ------------ Dataset Info ------------</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📊 Dataset&quot;</span><span class="p">)</span>
        <span class="n">predict_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_module</span><span class="o">.</span><span class="n">predict_dataset</span>
        <span class="k">if</span> <span class="n">predict_data</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">predict_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Predict Samples: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">predict_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Input: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__typing_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   └── Label: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">__typing_string</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   └── Predict Dataset: None&quot;</span><span class="p">)</span>

        <span class="c1"># ------------ Evaluation Metrics ------------</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📈 Evaluation Metrics&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_sample_evaluation_metrics</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_sample_evaluation_metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> (PER_SAMPLE)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   └── No evaluation metrics provided.&quot;</span><span class="p">)</span>

        <span class="c1"># ------------ Trainer Configuration ------------</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚙️ Trainer Config&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Max Epochs: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;max_epochs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Predict Batches: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;limit_predict_batches&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Accelerator: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;accelerator&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Strategy: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;strategy&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Devices: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ├── Num Nodes: </span><span class="si">{</span><span class="n">trainer_params</span><span class="p">[</span><span class="s1">&#39;num_nodes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   └── Seed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Experiment._evaluate_model">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment._evaluate_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_evaluate_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ckpts_to_evaluate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">print_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># --------- Checkpoints -------</span>
        <span class="n">checkpoints_to_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_paths</span>
        <span class="c1"># Check which checkpoints to evaluate (else, evaluate all)</span>
        <span class="k">if</span> <span class="n">ckpts_to_evaluate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ckpts_to_evaluate</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">ckpts_to_evaluate</span> <span class="o">=</span> <span class="p">[</span><span class="n">ckpts_to_evaluate</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">checkpoints_to_use</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">ckpt</span><span class="p">:</span> <span class="n">checkpoints_to_use</span><span class="p">[</span><span class="n">ckpt</span><span class="p">]</span> <span class="k">for</span> <span class="n">ckpt</span> <span class="ow">in</span> <span class="n">ckpts_to_evaluate</span>
                <span class="p">}</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkpoint </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">checkpoints_to_use</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Check if any checkpoint is found</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkpoints_to_use</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No checkpoints found in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># --------- Dataset -------</span>
        <span class="n">checkpoint_results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_module</span>
        <span class="k">if</span> <span class="n">data_module</span><span class="o">.</span><span class="n">predict_dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No predict dataset found in the data module. Please provide a predict dataset to perform evaluation.&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">ckpt_name</span><span class="p">,</span> <span class="n">ckpt_path</span> <span class="ow">in</span> <span class="n">checkpoints_to_use</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">predictions_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">results_filename</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">results_filename_per_sample</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">results</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">per_sample_results</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_predictions</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">predictions_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_predictions_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ckpt_name</span><span class="si">}</span><span class="s2">.npy&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_results</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">results_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ckpt_name</span><span class="si">}</span><span class="s2">.csv&quot;</span>
                <span class="n">results_filename_per_sample</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_results_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ckpt_name</span><span class="si">}</span><span class="s2">_per_sample.csv&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Load the model from the checkpoint</span>
            <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">instantiator</span><span class="o">.</span><span class="n">load_model_from_checkpoint</span><span class="p">(</span><span class="n">ckpt_path</span><span class="p">)</span>

            <span class="c1"># Trainer</span>
            <span class="n">trainer_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trainer_parameters</span><span class="p">(</span>
                <span class="n">enable_logging</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">trainer</span> <span class="o">=</span> <span class="n">get_trainer</span><span class="p">(</span><span class="o">**</span><span class="n">trainer_params</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">print_summary</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_evaluation_summary</span><span class="p">(</span>
                    <span class="n">trainer_params</span><span class="o">=</span><span class="n">trainer_params</span><span class="p">,</span>
                    <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
                    <span class="n">ckpt_path</span><span class="o">=</span><span class="n">ckpt_path</span><span class="p">,</span>
                    <span class="n">predictions_path</span><span class="o">=</span><span class="n">predictions_file</span><span class="p">,</span>
                    <span class="n">results_path</span><span class="o">=</span><span class="n">results_filename</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Perform prediction</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">perform_predict</span><span class="p">(</span>
                <span class="n">data_module</span><span class="o">=</span><span class="n">data_module</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">trainer</span><span class="o">=</span><span class="n">trainer</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">predictions_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">save_predictions</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">predictions_file</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predictions not saved...&quot;</span><span class="p">)</span>

            <span class="c1"># Perform evaluation</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">perform_evaluation</span><span class="p">(</span>
                    <span class="n">evaluation_metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span><span class="p">,</span>
                    <span class="n">data_module</span><span class="o">=</span><span class="n">data_module</span><span class="p">,</span>
                    <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
                    <span class="n">argmax_axis</span><span class="o">=</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">return_logits</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                    <span class="n">per_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_module</span><span class="o">.</span><span class="n">_predict_dataloader_kwargs</span><span class="p">[</span>
                        <span class="s2">&quot;batch_size&quot;</span>
                    <span class="p">],</span>
                    <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="s2">&quot;gpu&quot;</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">results_filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">save_results</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">results_filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results not saved...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No evaluation metrics provided. Skipping evaluation.&quot;</span><span class="p">)</span>

            <span class="c1"># Perform per-sample evaluation</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_sample_evaluation_metrics</span><span class="p">:</span>
                <span class="n">per_sample_results</span> <span class="o">=</span> <span class="n">perform_evaluation</span><span class="p">(</span>
                    <span class="n">evaluation_metrics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">per_sample_evaluation_metrics</span><span class="p">,</span>
                    <span class="n">data_module</span><span class="o">=</span><span class="n">data_module</span><span class="p">,</span>
                    <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
                    <span class="n">argmax_axis</span><span class="o">=</span><span class="p">(</span>
                        <span class="mi">1</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">return_logits</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="p">),</span>
                    <span class="n">per_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_module</span><span class="o">.</span><span class="n">_predict_dataloader_kwargs</span><span class="p">[</span>
                        <span class="s2">&quot;batch_size&quot;</span>
                    <span class="p">],</span>
                    <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span> <span class="o">==</span> <span class="s2">&quot;gpu&quot;</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">results_filename_per_sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">save_results</span><span class="p">(</span>
                        <span class="n">per_sample_results</span><span class="p">,</span>
                        <span class="n">results_filename_per_sample</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results not saved...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;No per-sample evaluation metrics provided. Skipping per-sample evaluation.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Store the results</span>
            <span class="n">checkpoint_results</span><span class="p">[</span><span class="n">ckpt_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;predictions_path&quot;</span><span class="p">:</span> <span class="n">predictions_file</span><span class="p">,</span>
                <span class="s2">&quot;results_path&quot;</span><span class="p">:</span> <span class="n">results_filename</span><span class="p">,</span>
                <span class="s2">&quot;results_path_per_sample&quot;</span><span class="p">:</span> <span class="n">results_filename_per_sample</span><span class="p">,</span>
                <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span>
                <span class="s2">&quot;results_per_sample&quot;</span><span class="p">:</span> <span class="n">per_sample_results</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkpoint </span><span class="si">{</span><span class="n">ckpt_name</span><span class="si">}</span><span class="s2"> evaluated!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">checkpoint_results</span></div>


    <span class="c1"># ---------- Default pipeline entrypoints and other methods ---------</span>
<div class="viewcode-block" id="Experiment._run">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment._run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">task</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">resume_from_ckpt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">print_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ckpts_to_evaluate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;fit&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_model</span><span class="p">(</span>
                <span class="n">resume_from_ckpt</span><span class="o">=</span><span class="n">resume_from_ckpt</span><span class="p">,</span>
                <span class="n">print_summary</span><span class="o">=</span><span class="n">print_summary</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;evaluate&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_model</span><span class="p">(</span>
                <span class="n">ckpts_to_evaluate</span><span class="o">=</span><span class="n">ckpts_to_evaluate</span><span class="p">,</span>
                <span class="n">print_summary</span><span class="o">=</span><span class="n">print_summary</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;fit-evaluate&quot;</span><span class="p">:</span>
            <span class="c1"># Train the model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_train_model</span><span class="p">(</span>
                <span class="n">resume_from_ckpt</span><span class="o">=</span><span class="n">resume_from_ckpt</span><span class="p">,</span>
                <span class="n">print_summary</span><span class="o">=</span><span class="n">print_summary</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Evaluate the model</span>
            <span class="n">eval_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_model</span><span class="p">(</span>
                <span class="n">ckpts_to_evaluate</span><span class="o">=</span><span class="n">ckpts_to_evaluate</span><span class="p">,</span>
                <span class="n">print_summary</span><span class="o">=</span><span class="n">print_summary</span><span class="p">,</span>
                <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">eval_results</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown task &#39;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&#39;. Supported tasks are: &#39;fit&#39;, &#39;evaluate&#39;, or &#39;fit-evaluate&#39;&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Experiment.cleanup">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment.cleanup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up the experiment by removing the log directory.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experiment at &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="si">}</span><span class="s2">&#39; cleaned up.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experiment at &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;experiment_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_name</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;log_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;checkpoints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint_paths</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;training_metrics&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">training_metrics_path</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;prediction_paths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prediction_paths</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;results_paths&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_paths</span>

        <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;not executed&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;checkpoints&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;executed&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;prediction_paths&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;predicted&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;results_paths&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;evaluated&quot;</span>

        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>

        <span class="k">return</span> <span class="n">d</span>

    <span class="c1"># ---------- Python methods ---------</span>

<div class="viewcode-block" id="Experiment.__str__">
<a class="viewcode-back" href="../../../autoapi/minerva/pipelines/experiment/index.html#minerva.pipelines.experiment.Experiment.__str__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">indent_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">spaces</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Indent each line of a string by a given number of spaces.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;No data.&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">spaces</span> <span class="o">+</span> <span class="n">line</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="n">line</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">exp_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;🚀 Experiment: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment_name</span><span class="si">}</span><span class="s2"> 🚀&quot;</span>
        <span class="n">pretrained_backbone</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_backbone_ckpt_path</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pretrained_backbone_ckpt_path</span>
            <span class="k">else</span> <span class="s2">&quot;FROM SCRATCH&quot;</span>
        <span class="p">)</span>

        <span class="n">limit_batches</span> <span class="o">=</span> <span class="s2">&quot;Limit batches: &quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">80</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="mi">80</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">exp_name</span><span class="p">))</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}{</span><span class="n">exp_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">80</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">🛠 Execution Details</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Execution ID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">execution_id</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Log Dir: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Seed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Accelerator: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">accelerator</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Devices: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Max Epochs: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_epochs</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Train Batches Limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_train_batches</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Val Batches Limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_val_batches</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   └── Test Batches Limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">limit_test_batches</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;all&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># f&quot;{&#39;=&#39; * 50}\n&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;🧠 Model Information</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Model Name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Pretrained Backbone: </span><span class="si">{</span><span class="n">pretrained_backbone</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Input Shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">input_shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   ├── Output Shape: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">output_shape</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;   └── Num Classes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_config</span><span class="o">.</span><span class="n">information</span><span class="o">.</span><span class="n">num_classes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">📂 Dataset Information</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent_text</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_module</span><span class="p">),</span><span class="w"> </span><span class="n">spaces</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Unicamp.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>